<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=640">

    <link rel="stylesheet" href="stylesheets/core.css" media="screen">
    <link rel="stylesheet" href="stylesheets/mobile.css" media="handheld, only screen and (max-device-width:640px)">
    <link rel="stylesheet" href="stylesheets/github-light.css">

    <script type="text/javascript" src="javascripts/modernizr.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="javascripts/headsmart.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function () {
        $('#main_content').headsmart()
      })
    </script>
    <title>Social-cms-backend by dai-shi</title>
  </head>

  <body>
    <a id="forkme_banner" href="https://github.com/dai-shi/social-cms-backend">View on GitHub</a>
    <div class="shell">

      <header>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <h1>Social-cms-backend</h1>
            <h2>Express middleware to provide schema-less REST APIs for creating a social networking website primarily using angular.js. It comes with built-in authentication, authorization and notification features.</h2>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
      </header>

      <section id="downloads">
        <span class="inner">
          <a href="https://github.com/dai-shi/social-cms-backend/zipball/master" class="zip"><em>download</em> .ZIP</a><a href="https://github.com/dai-shi/social-cms-backend/tarball/master" class="tgz"><em>download</em> .TGZ</a>
        </span>
      </section>


      <span class="banner-fix"></span>


      <section id="main_content">
        <h1>
<a id="social-cms-backend" class="anchor" href="#social-cms-backend" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>social-cms-backend</h1>

<p>Express middleware to provide schema-less REST APIs for creating a social networking website primarily using angular.js. It comes with built-in authentication, authorization and notification features.</p>

<h2>
<a id="motivation" class="anchor" href="#motivation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Motivation</h2>

<p>There exists several MVC framework libraries for node.js
that are inspired by Rails.  But they might be a bit outdated,
when it comes to angular.js, client-side MVW framework.
I would like to propose a maybe new style of web programming,
which is the combination of a domain-specific REST API library
(ready to use, no coding required) and client-side coding.</p>

<p>This project is to provide such a library for a web site
like SNS/Twitter/Facebook in a closed/private environment.</p>

<h2>
<a id="how-to-install" class="anchor" href="#how-to-install" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to install</h2>

<pre><code>$ npm install social-cms-backend
</code></pre>

<h2>
<a id="examples" class="anchor" href="#examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Examples</h2>

<p>The followings are minimal example code that uses social-cms-backend.</p>

<ul>
<li>
<a href="https://github.com/dai-shi/social-cms-backend/examples/auth-local/">auth-local</a> --- Simple BBS with local authentication</li>
<li>
<a href="https://github.com/dai-shi/social-cms-backend/examples/digest-and-following/">digest-and-following</a> --- An example app using digest auth and following feature (w/ socket.io)</li>
</ul>

<h2>
<a id="screencast" class="anchor" href="#screencast" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Screencast</h2>

<h3>
<a id="how-to-create-a-twitter-clone-in-15-minutes" class="anchor" href="#how-to-create-a-twitter-clone-in-15-minutes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to create a Twitter clone in 15 minutes</h3>

<p>Screencast preview (quadruple speed):</p>

<p><img src="http://dai-shi.github.io/social-cms-backend/ttyrecord.gif" alt="Preview"></p>

<p><a href="http://dai-shi.github.io/social-cms-backend/ttyplay.html" target="_blank">Controllable screencast at normal speed</a></p>

<p>Notes:</p>

<ul>
<li>There is a typo found after the recording.
<code>/javascript/main.js -&gt; /javascripts/main.js</code>
</li>
<li>The resulting code is available
<a href="https://github.com/dai-shi/twitter-clone-sample/tree/20130804_recorded">here</a>
</li>
<li>You can try the running web service of the code
<a href="http://twitterclonesample-nodeangularapp.rhcloud.com/" target="_blank">here</a>
</li>
</ul>

<h2>
<a id="how-to-use" class="anchor" href="#how-to-use" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to use</h2>

<h3>
<a id="minimal-configuration-with-local-authentication" class="anchor" href="#minimal-configuration-with-local-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Minimal configuration with local authentication</h3>

<pre><code>var express = require('express');
var SCB = require('social-cms-backend');
var app = express();
app.use(SCB.middleware({
  mongodb_url: 'mongodb://localhost:27017/socialcmsdb',
  passport_strategy: 'local'
}));
app.listen(3000);
</code></pre>

<h3>
<a id="typical-configuration-with-facebook-authentication" class="anchor" href="#typical-configuration-with-facebook-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Typical configuration with Facebook authentication:</h3>

<pre><code>var express = require('express');
var SCB = require('social-cms-backend');
var app = express();
app.use(SCB.middleware({
  mongodb_url: 'mongodb://localhost:27017/socialcmsdb',
  passport_strategy: 'facebook',
  facebook_app_id: process.env.FACEBOOK_APP_ID,
  facebook_app_secret: process.env.FACEBOOK_APP_SECRET
}));
app.listen(3000);
</code></pre>

<p>Notice two environment variables which have to be obtrained from <a href="https://developers.facebook.com/">https://developers.facebook.com/</a> and set properly. Refer <a href="https://developers.facebook.com/docs/apps/register">Facebook Doc</a> for more information.</p>

<h3>
<a id="configuration-with-socketio-v10" class="anchor" href="#configuration-with-socketio-v10" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration with socket.io v1.0:</h3>

<pre><code>var http = require('http');
var express = require('express');
var socket_io = require('socket.io');
var expressSession = require('express-session');
var SCB = require('social-cms-backend');
var app = express();
var SCB_options = {
  mongodb_url: 'mongodb://localhost:27017/socialcmsdb',
  session_middleware: expressSession({
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: true
  }),
  passport_strategy: 'facebook',
  facebook_app_id: process.env.FACEBOOK_APP_ID,
  facebook_app_secret: process.env.FACEBOOK_APP_SECRET
};
app.use(SCB.middleware(SCB_options));
var server = http.createServer(app);
var sio = socket_io(server);
sio.use(SCB.socket_io(SCB_options));
server.listen(3000);
</code></pre>

<h3>
<a id="configuration-for-http-digest-strategy" class="anchor" href="#configuration-for-http-digest-strategy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration for HTTP DIGEST strategy:</h3>

<pre><code>var SCB_options = {
  mongodb_url: 'mongodb://localhost:27017/socialcmsdb',
  passport_strategy: 'digest',
  auth_digest: {
    realm: 'my_realm'
  }
};
</code></pre>

<h3>
<a id="configuration-with-breezejs-support" class="anchor" href="#configuration-with-breezejs-support" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration with BreezeJS support:</h3>

<pre><code>var SCB_options = {
  mongodb_url: 'mongodb://localhost:27017/socialcmsdb',
  breeze_mongo: true,
  routes: [{
    object_type: 'user',
    object_prefix: '/breeze-service/users'
  }, {
    object_type: 'post',
    object_prefix: '/breeze-service/posts'
  }, {
    object_prefix: '/breeze-service/SaveChanges'
  }]
};
</code></pre>

<h2>
<a id="login-apis" class="anchor" href="#login-apis" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Login APIs</h2>

<p>The login API for Facebook authenticate is the following:</p>

<pre><code>GET /login/facebook
</code></pre>

<p>Typically, the HTML would look like this:</p>

<pre><code>&lt;a href="/login/facebook"&gt;Login&lt;/a&gt;
</code></pre>

<p>In the case of DIGEST authentication, the API is:</p>

<pre><code>GET /login/digest
</code></pre>

<p>The way to create a user for DIGEST authentication is:</p>

<pre><code>POST /adduser/digest
Content-Type: application/json
Content-Length: ...

{"name":"...","passhash":"...","initdata":"{...}"}
</code></pre>

<h2>
<a id="rest-apis" class="anchor" href="#rest-apis" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>REST APIs</h2>

<p>By default, there are 4 object types:</p>

<ul>
<li>user</li>
<li>group</li>
<li>post</li>
<li>like</li>
</ul>

<p>The following is the example of the post object endpoint.</p>

<h3>
<a id="list-post-objects" class="anchor" href="#list-post-objects" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>List post objects</h3>

<pre><code>GET /posts?query=...
</code></pre>

<p>The "query" query parameter is a MongoDB query parameter object
that is stringified (probably by JSON.stringify).</p>

<ul>
<li>
<code>skip</code> and <code>limit</code> query parameters are also supported.</li>
</ul>

<h3>
<a id="get-one-post-object" class="anchor" href="#get-one-post-object" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Get one post object</h3>

<pre><code>GET /posts/123
</code></pre>

<p>The "123" is the <code>_id</code> of the post.</p>

<h3>
<a id="save-a-new-post" class="anchor" href="#save-a-new-post" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Save a new post</h3>

<pre><code>POST /posts
</code></pre>

<p>The body is an object (JSON format) without system preserved properties such as
<code>_id</code>, <code>system</code>, <code>created_time</code>, <code>owner</code>, <code>meta</code>.</p>

<h3>
<a id="update-a-post" class="anchor" href="#update-a-post" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Update a post</h3>

<pre><code>PUT /posts/123
</code></pre>

<p>The body is a MongoDB update object (JSON format) using update operators.</p>

<h3>
<a id="delete-a-post" class="anchor" href="#delete-a-post" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Delete a post</h3>

<pre><code>DELETE /posts/123
</code></pre>

<h3>
<a id="count-posts" class="anchor" href="#count-posts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Count posts</h3>

<pre><code>GET /posts/count?query=...
</code></pre>

<p>This is a special endpoint.</p>

<h3>
<a id="get-following-posts" class="anchor" href="#get-following-posts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Get following posts</h3>

<pre><code>GET /posts/inbox
</code></pre>

<p>This is a special endpoint to only get posts that matches with predefined "following".
More description follows in the next section.</p>

<h3>
<a id="aggregate-posts" class="anchor" href="#aggregate-posts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Aggregate Posts</h3>

<pre><code>GET /posts/aggregate?pipeline=...
</code></pre>

<p>This is a special endpoint to use MongoDB aggregate command.
The "pipeline" query parameter is a MongoDB pipeline parameter object
that is stringified (probably by JSON.stringify).</p>

<h2>
<a id="user-and-group" class="anchor" href="#user-and-group" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>User and Group</h2>

<p>User objects can also be accessed by REST API.
For example, all user list can be fetched by</p>

<pre><code>GET /users
</code></pre>

<p>unless othrewise restricted.</p>

<p>To get login user information, use this special endpoint.</p>

<pre><code>GET /users/myself
</code></pre>

<p>To create a group, save a group object like the following:</p>

<pre><code>{
  members: [
    { user_id: 111 },
    { user_id: 112 },
    { user_id: 113 }
  ]
}
</code></pre>

<p>The <code>user_id</code> is the <code>_id</code> attribute of a user object.</p>

<p>You can also define nested groups like the following:</p>

<pre><code>{
  members: [
    { user_id: 111 },
    { group_id: 211 },
    { group_id: 212 }
  ]
}
</code></pre>

<p>The <code>group_id</code> is the <code>_id</code> attribute of a group object.</p>

<h2>
<a id="access-control" class="anchor" href="#access-control" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Access Control</h2>

<p>Object read permission is handled by the <code>scope</code> attribute.
For example, if an object has the <code>scope</code> like this,</p>

<pre><code>{
  data: { ... },
  scope: [
    { user_id: 111 },
    { group_id: 211 }
  ]
}
</code></pre>

<p>this object can only be accessed by the user <code>user_id=111</code> and
all members of the group <code>group_id=211</code>.
Notice <code>data</code> attribute is just an example.</p>

<p>Object write permission is based on ownership,
which means an object can only be updated by the user who first saved.</p>

<p>These access control can be customized by <code>hasPermission</code> SCB option.</p>

<h2>
<a id="followings-and-followers" class="anchor" href="#followings-and-followers" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Followings and Followers</h2>

<p>There is a special endpoint <code>inbox</code>.
if an object has <code>destination</code> property and if a user follows
that destination, that object is added to the user <code>inbox</code>.
For example, suppose a user with <code>user_id=111</code> follows
another user with <code>user_id=112</code>, a user object will be</p>

<pre><code>{
  _id: 111,
  following: [{
    user_id: 112
  }]
}
</code></pre>

<p>and if an object has <code>destination</code> like the following</p>

<pre><code>{
  destination: [{
    user_id: 112
  }]
}
</code></pre>

<p>the user with <code>user_id=111</code> will see this object in one's own <code>inbox</code>.</p>

<p>A user can also follow a group, in this case the user object would look
like the following.</p>

<pre><code>{
  _id: 111,
  following: [{
    group_id: 211
  }]
}
</code></pre>

<p>There is an SCB option <code>always_follow_myself</code> and if it is <code>true</code>,
it is equivalent to having a user <code>user_id=111</code> object like</p>

<pre><code>{
  _id: 111,
  following: [{
    user_id: 111
  }]
}
</code></pre>

<p>for all users.</p>

<h2>
<a id="push-by-socketio" class="anchor" href="#push-by-socketio" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Push by socket.io</h2>

<p>If an object has a <code>destination</code> property and a user follows it,
the server pushes the object to to the user by socket.io,
if socket.io is configured properly (See the example in "How To Use").</p>

<p>For example, if a "post" object like the following is inserted;</p>

<pre><code>{
  destination: [{
    group_id: 211
  }]
}
</code></pre>

<p>all the users who follow <code>group_id=211</code> will receive the whole object
as a message identified by <code>new-post</code>.
So the clients of the users are expected to listen to it by the following.</p>

<pre><code>socket.on('new-post', function(data) {
  //do something with data
});
</code></pre>

<h2>
<a id="extension-to-json-format" class="anchor" href="#extension-to-json-format" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Extension to JSON format</h2>

<p>Sometimes, we want to encode JavaScript objects in JSON.
We have a special notion for <code>Date</code> and <code>RegExp</code> like the following.</p>

<pre><code>{"key1":"val1","key2":"/Date(12345)/"} //12345 is milliseconds

{"key3":"val3","key4":"/RegExp([A-Z][a-z]+)/"}
</code></pre>

<h2>
<a id="defining-object-types" class="anchor" href="#defining-object-types" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Defining Object Types</h2>

<p>The examples above are all about the post object.
You can define any objects and their routes in an SCB option.</p>

<pre><code>routes: [{
  object_type: 'user',
  object_prefix: '/rest/users'
}, {
  object_type: 'group',
  object_prefix: '/rest/groups'
}, {
  object_type: 'article',
  object_prefix: '/rest/articles'
}, {
  object_type: 'comment',
  object_prefix: '/rest/comments'
}, {
  object_type: 'like',
  object_prefix: '/rest/likes'
}]
</code></pre>

<p>However, keeping <code>user</code> and <code>group</code> objects are always required for
authentication and authorization.</p>

<p>If you want to create a unique index, you can define it in an SCB option.</p>

<pre><code>ensure_unique_index: {
  object_type: 'like',
  object_fields: ['owner', 'article_id']
}
</code></pre>

<p>This will restrict one "like" at most for one article for each user.</p>

<h2>
<a id="todos" class="anchor" href="#todos" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>TODOs</h2>

<ul>
<li>Notification: email</li>
</ul>
      </section>

      <footer>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <p>this project by <a href="https://github.com/dai-shi">dai-shi</a> can be found on <a href="https://github.com/dai-shi/social-cms-backend">GitHub</a></p>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
        <p>Generated with <a href="https://pages.github.com">GitHub Pages</a> using Merlot</p>
        <span class="octocat"></span>
      </footer>

    </div>

    
  </body>
</html>
